<!DOCTYPE html>
<html>

<head>
    <title>Login - Supermarket</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Include custom CSS for dark mode -->
    <link rel="stylesheet" href="styles.css">
</head>

<body onload="Init()">
    <div class="text-center mt-3">
        <button id="darkModeButton" class="btn btn-secondary">Dark Mode</button>
    </div>

    <header class="bg-dark text-white">
        <div class="container">
            <h1>Welcome to Our Supermarket</h1>
            <nav>
                <ul class="nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="products.html">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contact.html">Contact</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="login.html">Login</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container center-form">
        <div class="col-md-6 offset-md-3">
            <h1 class="text-center">Login</h1>

            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" class="form-control" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" class="form-control" id="password" name="password" required>
            </div>
            <button type="submit" onclick="login()" class="btn btn-primary btn-block">Login</button>
            <p class="mt-3 text-center">Don't have an account? <a href="register.html">Create New Account</a></p>

            <div id="messagebox" class="text-center mt-3"></div>
        </div>
    </div>

    <!-- Include Bootstrap JS and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        const MY_SERVER = "http://127.0.0.1:8000"
        // Function to toggle dark mode
        function toggleDarkMode() {
            const body = document.body;
            body.classList.toggle("dark-mode");
            // Toggle button color
            const darkModeButton = document.getElementById("darkModeButton");
            if (darkModeButton.classList.contains("btn-secondary")) {
                darkModeButton.classList.replace("btn-secondary", "btn-primary");
                darkModeButton.innerText = "Normal Mode"
            } else {
                darkModeButton.classList.replace("btn-primary", "btn-secondary");
                darkModeButton.innerText = "Dark Mode"
            }
        }

        const darkModeButton = document.getElementById("darkModeButton");
        darkModeButton.addEventListener("click", toggleDarkMode);

        function DarkMode() {
            const darkmode = localStorage.getItem("darkmode")
            if (darkmode === "true") {
                const body = document.body;
                body.classList.toggle("dark-mode");
                const darkModeButton = document.getElementById("darkModeButton");
                if (darkModeButton.classList.contains("btn-secondary")) {
                    darkModeButton.classList.replace("btn-secondary", "btn-primary");
                    darkModeButton.innerText = "Normal Mode"
                } else {
                    darkModeButton.classList.replace("btn-primary", "btn-secondary");
                    darkModeButton.innerText = "Dark Mode"
                }
            }
        }

        const login = async () => {
            const uservalue = document.getElementById("username").value
            const passvalue = document.getElementById("password").value

            if (uservalue && passvalue) {

                let data = {
                    "username": uservalue,
                    "password": passvalue
                }
                try {
                    const response = await fetch(MY_SERVER + "/login/", {
                        method: "POST", // or 'PUT'
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });

                    const result = await response.json();
                    myDetails = parseJwt(result.access)
                    sessionStorage.setItem("token", result.access)
                    sessionStorage.setItem("userDetails", JSON.stringify({ "user": myDetails.username, "user_id": myDetails.user_id, "usermail": myDetails.email }))
                    window.location.href = 'index.html';
                    // Message("Logged In Successfully","success")
                } catch (error) {
                    console.error("Error:", error);
                }

            }
        }
        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }

        function Init(){
            DarkMode()
        }
    </script>
</body>

</html>